<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Interactive global supply chain map. Track shipping routes, ports, and logistics worldwide."
    />
    <meta name="theme-color" content="#0ea5e9" />
    <title>Supply Chain Mapper | IO Innovate</title>

    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"
    />

    <!-- Google AdSense -->
    <script
      async
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2456627863532019"
      crossorigin="anonymous"
    ></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --bg-primary: #0f172a;
        --bg-secondary: #1e293b;
        --bg-card: rgba(30, 41, 59, 0.9);
        --text-primary: #f1f5f9;
        --text-secondary: #94a3b8;
        --accent: #0ea5e9;
        --accent-light: rgba(14, 165, 233, 0.15);
        --success: #22c55e;
        --warning: #f59e0b;
        --danger: #ef4444;
        --border: rgba(148, 163, 184, 0.1);
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        min-height: 100vh;
      }

      /* Header */
      .header {
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border);
        padding: 1rem 1.5rem;
        position: sticky;
        top: 0;
        z-index: 1000;
        backdrop-filter: blur(12px);
      }

      .header-content {
        max-width: 1400px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        text-decoration: none;
      }

      .logo svg {
        width: 28px;
        height: 28px;
        color: var(--accent);
      }
      .logo span {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
      }

      .back-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: var(--accent-light);
        border: 1px solid rgba(14, 165, 233, 0.3);
        border-radius: 8px;
        color: var(--accent);
        text-decoration: none;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s;
      }

      .back-btn:hover {
        background: rgba(14, 165, 233, 0.25);
      }

      /* Main Layout */
      .main {
        max-width: 1400px;
        margin: 0 auto;
        padding: 1.5rem;
      }
      
      /* Search Box */
      .search-container {
        max-width: 600px;
        margin: 0 auto 1.5rem;
        position: relative;
      }
      
      .search-input {
        width: 100%;
        padding: 0.875rem 1rem 0.875rem 3rem;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 50px;
        color: var(--text-primary);
        font-size: 0.9rem;
        transition: all 0.3s;
      }
      
      .search-input:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-light);
      }
      
      .search-input::placeholder {
        color: var(--text-secondary);
      }
      
      .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
        pointer-events: none;
      }
      
      .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 12px;
        margin-top: 0.5rem;
        max-height: 300px;
        overflow-y: auto;
        box-shadow: 0 8px 24px rgba(0,0,0,0.5);
        z-index: 100;
        display: none;
      }
      
      .search-results.active {
        display: block;
      }
      
      .search-result-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        border-bottom: 1px solid var(--border);
        transition: background 0.2s;
      }
      
      .search-result-item:hover {
        background: var(--accent-light);
      }
      
      .search-result-item:last-child {
        border-bottom: none;
      }
      
      .search-result-title {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 0.875rem;
      }
      
      .search-result-meta {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
      }

      /* Stats Bar */
      .stats-bar {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .stat-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 1rem 1.25rem;
        text-align: center;
      }

      .stat-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--accent);
      }

      .stat-value.live::after {
        content: "";
        display: inline-block;
        width: 8px;
        height: 8px;
        background: var(--success);
        border-radius: 50%;
        margin-left: 8px;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.5;
          transform: scale(1.2);
        }
      }

      .stat-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      /* Map Section */
      .map-section {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 16px;
        overflow: hidden;
        margin-bottom: 1.5rem;
      }

      .map-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--border);
        flex-wrap: wrap;
        gap: 1rem;
      }

      .map-title {
        font-size: 1.125rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .map-title svg {
        width: 20px;
        height: 20px;
        color: var(--accent);
      }

      .map-controls {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }
      
      .map-filters {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        align-items: center;
      }
      
      .filter-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        font-weight: 500;
        margin-right: 0.25rem;
      }
      
      .action-btn {
        padding: 0.5rem;
        background: var(--accent-light);
        border: 1px solid rgba(14, 165, 233, 0.3);
        border-radius: 8px;
        color: var(--accent);
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.4rem;
      }
      
      .action-btn:hover {
        background: rgba(14, 165, 233, 0.25);
        border-color: var(--accent);
      }
      
      .action-btn svg {
        width: 16px;
        height: 16px;
      }

      .toggle-btn {
        padding: 0.5rem 1rem;
        background: transparent;
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text-secondary);
        font-size: 0.8rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.4rem;
      }

      .toggle-btn:hover {
        border-color: var(--accent);
        color: var(--accent);
      }
      .toggle-btn.active {
        background: var(--accent);
        border-color: var(--accent);
        color: white;
      }
      .toggle-btn svg {
        width: 14px;
        height: 14px;
      }

      #map {
        height: 600px;
        background: #0c1929;
        position: relative;
      }
      
      /* Route hover effect */
      .leaflet-interactive:hover {
        stroke-width: 4 !important;
        opacity: 1 !important;
        cursor: pointer;
      }
      
      /* Active route highlight */
      .route-active {
        stroke-width: 5 !important;
        opacity: 1 !important;
        filter: drop-shadow(0 0 8px currentColor);
      }
      
      /* Animated ship on route */
      .ship-marker {
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        box-shadow: 0 2px 8px rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        animation: shipMove 4s ease-in-out infinite;
      }
      
      @keyframes shipMove {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.2); }
      }
      
      /* Info overlay */
      .map-info-overlay {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(15, 23, 42, 0.95);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 12px 16px;
        z-index: 1000;
        backdrop-filter: blur(8px);
        min-width: 200px;
      }
      
      .info-overlay-title {
        font-size: 0.7rem;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
      }
      
      .info-overlay-item {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        margin: 6px 0;
        color: var(--text-primary);
      }
      
      .info-overlay-label {
        color: var(--text-secondary);
      }
      
      .info-overlay-value {
        font-weight: 600;
      }
      
      .live-clock {
        color: var(--accent);
        font-family: monospace;
      }

      /* Port Cards Grid */
      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .section-title {
        font-size: 1.125rem;
        font-weight: 600;
      }

      .filter-group {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }

      .filter-btn {
        padding: 0.4rem 0.875rem;
        background: transparent;
        border: 1px solid var(--border);
        border-radius: 20px;
        color: var(--text-secondary);
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s;
      }

      .filter-btn:hover {
        border-color: var(--accent);
        color: var(--accent);
      }
      .filter-btn.active {
        background: var(--accent);
        border-color: var(--accent);
        color: white;
      }

      .ports-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1rem;
      }

      .port-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 1.25rem;
        transition: all 0.2s;
        cursor: pointer;
      }

      .port-card:hover {
        border-color: var(--accent);
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      }

      .port-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
      }

      .port-name {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
      }

      .port-country {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
      }

      .port-rank {
        background: var(--accent-light);
        color: var(--accent);
        padding: 0.25rem 0.625rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
      }

      .port-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.75rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border);
      }

      .port-stat {
        text-align: center;
      }

      .port-stat-value {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
      }

      .port-stat-value.good {
        color: var(--success);
      }
      .port-stat-value.warning {
        color: var(--warning);
      }

      .port-stat-label {
        font-size: 0.65rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        margin-top: 0.125rem;
      }

      /* Chokepoints Section */
      .chokepoints-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1rem;
        margin-top: 1.5rem;
      }

      .choke-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 1rem 1.25rem;
        cursor: pointer;
        transition: all 0.2s;
      }

      .choke-card:hover {
        border-color: var(--accent);
        transform: translateY(-2px);
      }

      .choke-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
      }

      .choke-name {
        font-weight: 600;
        font-size: 0.9rem;
      }

      .choke-status {
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-size: 0.65rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .choke-status.open {
        background: rgba(34, 197, 94, 0.2);
        color: var(--success);
      }
      .choke-status.restricted {
        background: rgba(245, 158, 11, 0.2);
        color: var(--warning);
      }
      .choke-status.elevated-risk {
        background: rgba(239, 68, 68, 0.2);
        color: var(--danger);
      }

      .choke-info {
        font-size: 0.8rem;
        color: var(--text-secondary);
        line-height: 1.5;
      }

      .choke-info p {
        margin: 0.25rem 0;
      }

      /* Leaflet Customization */
      .leaflet-popup-content-wrapper {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border-radius: 10px;
        border: 1px solid var(--border);
      }

      .leaflet-popup-tip {
        background: var(--bg-secondary);
      }

      .popup-content {
        padding: 0.5rem;
      }
      .popup-content h4 {
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
      }
      .popup-content p {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin: 0.25rem 0;
      }
      .popup-content .highlight {
        color: var(--accent);
        font-weight: 600;
      }

      /* Footer */
      .footer {
        text-align: center;
        padding: 2rem;
        color: var(--text-secondary);
        font-size: 0.8rem;
        border-top: 1px solid var(--border);
        margin-top: 2rem;
      }

      .footer a {
        color: var(--accent);
        text-decoration: none;
      }
      .footer a:hover {
        text-decoration: underline;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .header {
          padding: 0.875rem 1rem;
        }

        .header-content {
          flex-direction: column;
          align-items: flex-start;
          gap: 0.75rem;
        }

        .logo {
          gap: 0.5rem;
        }

        .logo svg {
          width: 24px;
          height: 24px;
        }

        .logo span {
          font-size: 1.1rem;
        }

        .back-btn {
          padding: 0.4rem 0.875rem;
          font-size: 0.8rem;
        }

        .main {
          padding: 1rem;
        }

        .search-container {
          margin-bottom: 1.25rem;
        }

        .search-input {
          padding: 0.75rem 0.875rem 0.75rem 2.75rem;
          font-size: 0.875rem;
        }

        .search-icon {
          left: 0.875rem;
        }

        .search-results {
          max-height: 250px;
        }

        .search-result-item {
          padding: 0.625rem 0.875rem;
        }

        .search-result-title {
          font-size: 0.8rem;
        }

        .search-result-meta {
          font-size: 0.7rem;
        }

        .stats-bar {
          grid-template-columns: repeat(2, 1fr);
          gap: 0.75rem;
          margin-bottom: 1.25rem;
        }

        .stat-card {
          padding: 0.875rem 1rem;
        }

        .stat-value {
          font-size: 1.5rem;
        }

        .stat-label {
          font-size: 0.7rem;
        }

        .map-section {
          margin-bottom: 1.25rem;
          border-radius: 12px;
        }

        .map-header {
          padding: 0.875rem 1rem;
          flex-direction: column;
          align-items: flex-start;
          gap: 0.75rem;
        }

        .map-title {
          font-size: 1rem;
        }

        .map-controls {
          width: 100%;
          flex-direction: column;
        }

        .map-filters {
          width: 100%;
          flex-wrap: wrap;
        }

        .filter-label {
          width: 100%;
          margin-bottom: 0.25rem;
        }

        .action-btn {
          padding: 0.4rem 0.75rem;
          font-size: 0.8rem;
        }

        .toggle-btn {
          padding: 0.4rem 0.75rem;
          font-size: 0.75rem;
          flex: 1;
          justify-content: center;
        }

        .toggle-btn svg {
          width: 12px;
          height: 12px;
        }

        #map {
          height: 350px;
        }

        .map-info-overlay {
          top: 10px;
          right: 10px;
          left: 10px;
          padding: 10px 12px;
          min-width: auto;
        }

        .info-overlay-title {
          font-size: 0.65rem;
          margin-bottom: 6px;
        }

        .info-overlay-item {
          font-size: 0.75rem;
          margin: 4px 0;
        }

        .section-header {
          flex-direction: column;
          align-items: flex-start;
          margin-bottom: 0.875rem;
          gap: 0.75rem;
        }

        .section-title {
          font-size: 1rem;
        }

        .filter-group {
          width: 100%;
          gap: 0.4rem;
        }

        .filter-btn {
          padding: 0.35rem 0.75rem;
          font-size: 0.75rem;
          flex: 1;
          text-align: center;
        }

        .ports-grid {
          grid-template-columns: 1fr;
          gap: 0.875rem;
        }

        .port-card {
          padding: 1rem;
        }

        .port-header {
          margin-bottom: 0.875rem;
        }

        .port-name {
          font-size: 0.95rem;
        }

        .port-country {
          font-size: 0.7rem;
        }

        .port-rank {
          padding: 0.2rem 0.5rem;
          font-size: 0.7rem;
        }

        .port-stats {
          grid-template-columns: repeat(3, 1fr);
          gap: 0.5rem;
          padding-top: 0.875rem;
        }

        .port-stat-value {
          font-size: 0.95rem;
        }

        .port-stat-label {
          font-size: 0.6rem;
        }

        .chokepoints-grid {
          grid-template-columns: 1fr;
          gap: 0.875rem;
          margin-top: 1.25rem;
        }

        .choke-card {
          padding: 0.875rem 1rem;
        }

        .choke-header {
          margin-bottom: 0.625rem;
        }

        .choke-name {
          font-size: 0.85rem;
        }

        .choke-status {
          padding: 0.15rem 0.4rem;
          font-size: 0.6rem;
        }

        .choke-info {
          font-size: 0.75rem;
        }

        .popup-content {
          padding: 0.4rem;
        }

        .popup-content h4 {
          font-size: 0.85rem;
          margin-bottom: 0.4rem;
        }

        .popup-content p {
          font-size: 0.75rem;
        }

        .footer {
          padding: 1.5rem 1rem;
          font-size: 0.75rem;
          margin-top: 1.5rem;
        }
      }

      /* Loading State */
      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 200px;
        color: var(--text-secondary);
      }

      .spinner {
        width: 32px;
        height: 32px;
        border: 3px solid var(--border);
        border-top-color: var(--accent);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 1rem;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Animated routes */
      .animated-route {
        stroke-dasharray: 8, 8;
        animation: dash 30s linear infinite;
      }
      @keyframes dash {
        to {
          stroke-dashoffset: -100;
        }
      }

      /* Port pulse animation */
      .port-pulse {
        animation: portPulse 2s ease-out infinite;
      }
      @keyframes portPulse {
        0% {
          transform: scale(1);
          opacity: 0.8;
        }
        50% {
          transform: scale(1.5);
          opacity: 0.4;
        }
        100% {
          transform: scale(2);
          opacity: 0;
        }
      }

      /* Map Legend */
      .map-legend {
        position: absolute;
        bottom: 20px;
        left: 20px;
        background: rgba(15, 23, 42, 0.95);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 12px 16px;
        z-index: 1000;
        min-width: 160px;
        backdrop-filter: blur(8px);
      }

      .legend-title {
        font-size: 0.7rem;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 10px;
        padding-bottom: 6px;
        border-bottom: 1px solid var(--border);
      }

      .legend-section {
        margin-bottom: 10px;
      }

      .legend-section:last-child {
        margin-bottom: 0;
      }

      .legend-section-title {
        font-size: 0.65rem;
        color: var(--text-secondary);
        margin-bottom: 6px;
        font-weight: 500;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.7rem;
        color: var(--text-primary);
        margin: 4px 0;
      }

      .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        flex-shrink: 0;
      }

      .legend-line {
        width: 20px;
        height: 3px;
        border-radius: 2px;
        flex-shrink: 0;
      }

      .legend-icon {
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      /* Custom port marker */
      .port-marker {
        position: relative;
      }

      .port-marker-inner {
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
      }

      .port-marker-pulse {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border-radius: 50%;
        pointer-events: none;
      }

      /* Airport marker */
      .airport-marker {
        background: #a855f7;
        border: 2px solid white;
        border-radius: 4px;
        padding: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="header-content">
        <a href="/" class="logo">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
          </svg>
          <span>Supply Chain Mapper</span>
        </a>
        <a href="/tools.html" class="back-btn">
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M19 12H5M12 19l-7-7 7-7" />
          </svg>
          All Tools
        </a>
      </div>
    </header>

    <main class="main">
      <!-- Search Box -->
      <div class="search-container">
        <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
        </svg>
        <input 
          type="text" 
          class="search-input" 
          id="searchInput"
          placeholder="Search ports, routes, or chokepoints..."
        />
        <div class="search-results" id="searchResults"></div>
      </div>
      
      <!-- Stats Bar -->
      <div class="stats-bar" id="statsBar">
        <div class="stat-card">
          <div class="stat-value live" id="activeShipments">--</div>
          <div class="stat-label">Active Shipments</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalPorts">--</div>
          <div class="stat-label">Major Ports</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="globalTEU">--</div>
          <div class="stat-label">Global TEU (2024)</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="avgEfficiency">--</div>
          <div class="stat-label">Avg Efficiency</div>
        </div>
      </div>

      <!-- Map Section -->
      <section class="map-section">
        <div class="map-header">
          <h2 class="map-title">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <circle cx="12" cy="12" r="10" />
              <path
                d="M2 12h20M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"
              />
            </svg>
            Global Shipping Network
          </h2>
          <div class="map-controls">
            <button class="toggle-btn active" data-layer="routes">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" />
              </svg>
              Routes
            </button>
            <button class="toggle-btn active" data-layer="ports">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <circle cx="12" cy="12" r="3" />
                <path d="M12 2v4m0 12v4m10-10h-4M6 12H2" />
              </svg>
              Ports
            </button>
            <button class="toggle-btn" data-layer="chokepoints">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                />
              </svg>
              Chokepoints
            </button>
            <button class="toggle-btn" data-layer="airports">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M21 16v-2l-8-5V3.5a1.5 1.5 0 00-3 0V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"
                />
              </svg>
              Airports
            </button>
          </div>
          <span class="filter-label" style="margin-left: 1rem;">Routes:</span>
          <button class="toggle-btn" data-route-filter="all">All</button>
          <button class="toggle-btn" data-route-filter="trans-pacific">Trans-Pacific</button>
          <button class="toggle-btn" data-route-filter="asia-europe">Asia-Europe</button>
          <button class="toggle-btn" data-route-filter="americas">Americas</button>
        </div>
        <div style="display: flex; gap: 0.5rem; margin-left: auto;">
          <button class="action-btn" id="fullscreenBtn" title="Toggle Fullscreen">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M8 3H5a2 2 0 00-2 2v3m18 0V5a2 2 0 00-2-2h-3m0 18h3a2 2 0 002-2v-3M3 16v3a2 2 0 002 2h3"/>
            </svg>
            <span style="font-size: 0.75rem;">Fullscreen</span>
          </button>
          <button class="action-btn" id="exportBtn" title="Export Data">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
            </svg>
            <span style="font-size: 0.75rem;">Export</span>
          </button>
        </div>
      </div>
        <div id="map">
          <!-- Info Overlay -->
          <div class="map-info-overlay">
            <div class="info-overlay-title">Live Data</div>
            <div class="info-overlay-item">
              <span class="info-overlay-label">UTC Time:</span>
              <span class="info-overlay-value live-clock" id="liveClock">--:--:--</span>
            </div>
            <div class="info-overlay-item">
              <span class="info-overlay-label">Visible Routes:</span>
              <span class="info-overlay-value" id="visibleRoutes">14</span>
            </div>
            <div class="info-overlay-item">
              <span class="info-overlay-label">Zoom Level:</span>
              <span class="info-overlay-value" id="zoomLevel">2</span>
            </div>
          </div>
          
          <!-- Legend -->
          <div class="map-legend">
            <div class="legend-title">Map Legend</div>
            <div class="legend-section">
              <div class="legend-section-title">Port Efficiency</div>
              <div class="legend-item">
                <span class="legend-color" style="background: #22c55e"></span>
                High (90%+)
              </div>
              <div class="legend-item">
                <span class="legend-color" style="background: #0ea5e9"></span>
                Good (80-89%)
              </div>
              <div class="legend-item">
                <span class="legend-color" style="background: #f59e0b"></span>
                Moderate (&lt;80%)
              </div>
            </div>
            <div class="legend-section">
              <div class="legend-section-title">Route Status</div>
              <div class="legend-item">
                <span class="legend-line" style="background: #22c55e"></span>
                Normal
              </div>
              <div class="legend-item">
                <span class="legend-line" style="background: #f59e0b"></span>
                Advisory
              </div>
              <div class="legend-item">
                <span class="legend-line" style="background: #ef4444"></span>
                Delayed
              </div>
            </div>
            <div class="legend-section">
              <div class="legend-section-title">Hub Types</div>
              <div class="legend-item">
                <span class="legend-color" style="background: #0ea5e9"></span>
                Port
              </div>
              <div class="legend-item">
                <span class="legend-color" style="background: #a855f7"></span>
                Airport
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Ports Section -->
      <section>
        <div class="section-header">
          <h2 class="section-title">Major Global Ports</h2>
          <div class="filter-group">
            <button class="filter-btn active" data-region="all">All</button>
            <button class="filter-btn" data-region="asia">Asia</button>
            <button class="filter-btn" data-region="europe">Europe</button>
            <button class="filter-btn" data-region="americas">Americas</button>
            <button class="filter-btn" data-region="middle-east">
              Middle East
            </button>
          </div>
        </div>
        <div class="ports-grid" id="portsGrid">
          <div class="loading">
            <div class="spinner"></div>
            Loading ports...
          </div>
        </div>
      </section>

      <!-- Chokepoints Section -->
      <section>
        <h2 class="section-title" style="margin-top: 2rem; margin-bottom: 1rem">
          Critical Chokepoints
        </h2>
        <div class="chokepoints-grid" id="chokepointsGrid">
          <div class="loading">
            <div class="spinner"></div>
            Loading...
          </div>
        </div>
      </section>
    </main>

    <footer class="footer">
      <p>
        Data updated for 2024 • <a href="/tools.html">More Tools</a> •
        <a href="/">IO Innovate</a>
      </p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
      // Global state
      let map, routesLayer, portsLayer, chokepointsLayer, airportsLayer;
      let supplyChainData = null;
      let allRoutes = [];
      let activeRouteFilter = 'all';

      // Initialize the app
      async function init() {
        await loadData();
        initMap();
        renderStats();
        renderPorts();
        renderChokepoints();
        setupEventListeners();
      }

      // Load data from JSON
      async function loadData() {
        try {
          const response = await fetch("/data/supplychain.json");
          supplyChainData = await response.json();
        } catch (error) {
          console.error("Failed to load data:", error);
          supplyChainData = {
            hubs: [],
            routes: [],
            chokepoints: [],
            globalStats: {},
          };
        }
      }

      // Initialize Leaflet map
      function initMap() {
        map = L.map("map", {
          center: [20, 0],
          zoom: 2,
          minZoom: 2,
          maxZoom: 8,
          worldCopyJump: true,
        });

        // Dark ocean tile layer
        L.tileLayer(
          "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
          {
            attribution: "© OpenStreetMap © CARTO",
            subdomains: "abcd",
            maxZoom: 19,
          }
        ).addTo(map);

        // Create layer groups
        routesLayer = L.layerGroup().addTo(map);
        portsLayer = L.layerGroup().addTo(map);
        chokepointsLayer = L.layerGroup();
        airportsLayer = L.layerGroup();

        drawRoutes();
        drawPorts();
        drawChokepoints();
        drawAirports();
      }

      // Get route color based on status
      function getRouteColor(status) {
        switch (status) {
          case "delayed":
            return "#ef4444";
          case "advisory":
            return "#f59e0b";
          case "normal":
          default:
            return "#22c55e";
        }
      }

      // Draw shipping routes with waypoints for realistic paths
      function drawRoutes() {
        if (!supplyChainData.routes) return;

        supplyChainData.routes.forEach((route) => {
          // Build the full path: from -> waypoints -> to
          const pathPoints = [];
          pathPoints.push([route.from.lat, route.from.lon]);

          // Add waypoints if they exist
          if (route.waypoints && route.waypoints.length > 0) {
            route.waypoints.forEach((wp) => {
              pathPoints.push(wp);
            });
          }

          pathPoints.push([route.to.lat, route.to.lon]);

          // Split route segments that cross the date line
          const segments = [];
          let currentSegment = [pathPoints[0]];
          
          for (let i = 1; i < pathPoints.length; i++) {
            const prev = pathPoints[i - 1];
            const curr = pathPoints[i];
            const lonDiff = Math.abs(curr[1] - prev[1]);
            
            // If longitude jumps more than 180°, we're crossing the date line
            if (lonDiff > 180) {
              // Complete current segment
              segments.push([...currentSegment]);
              // Start new segment
              currentSegment = [curr];
            } else {
              currentSegment.push(curr);
            }
          }
          
          // Add the final segment
          if (currentSegment.length > 0) {
            segments.push(currentSegment);
          }

          // Color based on status
          const color = getRouteColor(route.status);

          // Draw each segment
          const polylines = segments.filter(seg => seg.length >= 2).map(segment => {
            return L.polyline(segment, {
              color: color,
              weight: 2.5,
              opacity: 0.75,
              dashArray: "8, 4",
              className: "animated-route",
              smoothFactor: 1.5,
            });
          });
          
          // Use the first polyline for the popup
          const polyline = polylines[0];

          // Status badge for popup
          const statusBadge =
            route.status === "normal"
              ? '<span style="color: #22c55e;">● NORMAL</span>'
              : route.status === "delayed"
              ? '<span style="color: #ef4444;">● DELAYED</span>'
              : '<span style="color: #f59e0b;">● ADVISORY</span>';

          polyline.bindPopup(`
          <div class="popup-content">
            <h4>${route.name}</h4>
            <p>Status: ${statusBadge}</p>
            <p>Distance: <span class="highlight">${route.distance?.toLocaleString()} km</span></p>
            <p>Transit: <span class="highlight">${
              route.transitDays
            } days</span></p>
            <p>Vessels: <span class="highlight">${route.vessels}</span></p>
            <p>Ship Type: <span class="highlight">${
              route.shipType || "container"
            }</span></p>
          </div>
        `);

          routesLayer.addLayer(polyline);
          
          // Add all segments to the layer
          polylines.forEach(pl => {
            if (pl !== polyline) {
              routesLayer.addLayer(pl);
            }
          });
          
          // Store route reference for filtering (store all polylines)
          allRoutes.push({
            polyline: polyline,
            polylines: polylines,
            data: route,
            id: route.id
          });
        });
      }
      
      // Filter routes by category
      function filterRoutes(category) {
        activeRouteFilter = category;
        allRoutes.forEach(({polyline, polylines, data}) => {
          const show = category === 'all' || 
                      (category === 'trans-pacific' && (data.id.includes('pacific') || data.id.includes('japan-la') || data.id.includes('korea'))) ||
                      (category === 'asia-europe' && (data.id.includes('asia-europe') || data.id.includes('mideast') || data.id.includes('se-asia'))) ||
                      (category === 'americas' && (data.id.includes('atlantic') || data.id.includes('us-coastal') || data.id.includes('gulf')));
          
          if (show) {
            polylines.forEach(pl => routesLayer.addLayer(pl));
          } else {
            polylines.forEach(pl => routesLayer.removeLayer(pl));
          }
        });
        updateMapInfo();
      }

      // Create anchor icon SVG for ports
      function createPortIcon(color, size) {
        const iconSize = size + 8;
        return L.divIcon({
          className: "port-marker",
          html: `
            <div class="port-marker-inner" style="width: ${iconSize}px; height: ${iconSize}px; background: ${color};">
              <svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="white">
                <path d="M12 2a1 1 0 011 1v3.26a4.5 4.5 0 013 4.24V13h3a1 1 0 110 2h-3v3a5 5 0 01-8.66 3.41 1 1 0 111.32-1.5A3 3 0 0011 18v-3H8a1 1 0 110-2h3v-2.5a4.5 4.5 0 013-4.24V3a1 1 0 011-1zm0 6a2.5 2.5 0 00-2.5 2.5V13h5v-2.5A2.5 2.5 0 0012 8z"/>
              </svg>
            </div>
            <div class="port-marker-pulse" style="width: ${
              iconSize * 2
            }px; height: ${
            iconSize * 2
          }px; background: ${color}; animation: portPulse 3s ease-out infinite;"></div>
          `,
          iconSize: [iconSize, iconSize],
          iconAnchor: [iconSize / 2, iconSize / 2],
        });
      }

      // Draw port markers
      function drawPorts() {
        if (!supplyChainData.hubs) return;

        const ports = supplyChainData.hubs.filter((h) => h.type === "port");

        ports.forEach((port) => {
          const size = Math.min(Math.max(port.throughput / 3, 12), 24);
          const color =
            port.efficiency >= 90
              ? "#22c55e"
              : port.efficiency >= 80
              ? "#0ea5e9"
              : "#f59e0b";

          const marker = L.marker([port.lat, port.lon], {
            icon: createPortIcon(color, size),
          });

          const efficiencyColor =
            port.efficiency >= 90
              ? "#22c55e"
              : port.efficiency >= 80
              ? "#0ea5e9"
              : "#f59e0b";

          marker.bindPopup(`
          <div class="popup-content">
            <h4>⚓ ${port.name}</h4>
            <p>${port.country}</p>
            <p>Throughput: <span class="highlight">${
              port.throughput
            }M TEU</span></p>
            <p>Efficiency: <span style="color: ${efficiencyColor}; font-weight: 600;">${
            port.efficiency
          }%</span></p>
            <p>Global Rank: <span class="highlight">#${
              port.ranking || "N/A"
            }</span></p>
            <p>Vessels: <span class="highlight">${
              port.vessels || "N/A"
            }</span></p>
          </div>
        `);

          portsLayer.addLayer(marker);
        });
      }

      // Draw chokepoints
      function drawChokepoints() {
        if (!supplyChainData.chokepoints) return;

        supplyChainData.chokepoints.forEach((cp) => {
          const color =
            cp.status === "open"
              ? "#22c55e"
              : cp.status === "restricted"
              ? "#f59e0b"
              : "#ef4444";

          // Warning triangle icon for chokepoints
          const icon = L.divIcon({
            className: "chokepoint-marker",
            html: `
              <div style="position: relative;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="${color}" stroke="white" stroke-width="1.5">
                  <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
              </div>
            `,
            iconSize: [24, 24],
            iconAnchor: [12, 12],
          });

          const marker = L.marker([cp.lat, cp.lon], { icon });

          marker.bindPopup(`
          <div class="popup-content">
            <h4>⚠️ ${cp.name}</h4>
            <p>Status: <span style="color: ${color}; font-weight: 600;">${cp.status
            ?.toUpperCase()
            .replace("-", " ")}</span></p>
            <p>Traffic: ${cp.traffic || "N/A"}</p>
            <p>Transit Time: ${cp.transitTime || "N/A"}</p>
            <p>Trade Share: ${cp.tradeShare || "N/A"}</p>
          </div>
        `);

          chokepointsLayer.addLayer(marker);
        });
      }

      // Draw airport markers
      function drawAirports() {
        if (!supplyChainData.hubs) return;

        const airports = supplyChainData.hubs.filter(
          (h) => h.type === "airport"
        );

        airports.forEach((airport) => {
          // Plane icon for airports
          const icon = L.divIcon({
            className: "airport-marker-container",
            html: `
              <div class="airport-marker">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
                  <path d="M21 16v-2l-8-5V3.5a1.5 1.5 0 00-3 0V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/>
                </svg>
              </div>
            `,
            iconSize: [24, 24],
            iconAnchor: [12, 12],
          });

          const marker = L.marker([airport.lat, airport.lon], { icon });

          marker.bindPopup(`
          <div class="popup-content">
            <h4>✈️ ${airport.name}</h4>
            <p>${airport.country}</p>
            <p>Cargo Volume: <span class="highlight">${
              airport.throughput || "N/A"
            }M tons</span></p>
            <p>Efficiency: <span class="highlight">${
              airport.efficiency || "N/A"
            }%</span></p>
            ${
              airport.description
                ? `<p style="font-size: 0.7rem; margin-top: 6px; color: #94a3b8;">${airport.description}</p>`
                : ""
            }
          </div>
        `);

          airportsLayer.addLayer(marker);
        });
      }

      // Render stats
      function renderStats() {
        const stats = supplyChainData.globalStats || {};
        const ports =
          supplyChainData.hubs?.filter((h) => h.type === "port") || [];

        document.getElementById("activeShipments").textContent =
          stats.activeShipments?.toLocaleString() || "3,142";
        document.getElementById("totalPorts").textContent = ports.length;
        document.getElementById("globalTEU").textContent = stats.globalTEU2024
          ? `${(stats.globalTEU2024 / 1000000).toFixed(0)}M`
          : "920M";

        const avgEff = ports.length
          ? Math.round(
              ports.reduce((sum, p) => sum + (p.efficiency || 0), 0) /
                ports.length
            )
          : 0;
        document.getElementById("avgEfficiency").textContent = `${avgEff}%`;
      }

      // Render port cards
      function renderPorts(region = "all") {
        const grid = document.getElementById("portsGrid");
        let ports =
          supplyChainData.hubs?.filter((h) => h.type === "port") || [];

        if (region !== "all") {
          ports = ports.filter((p) => p.region === region);
        }

        // Sort by throughput
        ports.sort((a, b) => (b.throughput || 0) - (a.throughput || 0));

        if (ports.length === 0) {
          grid.innerHTML =
            '<p style="color: var(--text-secondary); padding: 2rem;">No ports found for this region.</p>';
          return;
        }

        grid.innerHTML = ports
          .slice(0, 12)
          .map(
            (port) => `
        <div class="port-card" onclick="focusPort(${port.lat}, ${port.lon})">
          <div class="port-header">
            <div>
              <div class="port-name">${port.name}</div>
              <div class="port-country">${port.country}</div>
            </div>
            ${
              port.ranking
                ? `<div class="port-rank">#${port.ranking}</div>`
                : ""
            }
          </div>
          <div class="port-stats">
            <div class="port-stat">
              <div class="port-stat-value">${port.throughput}M</div>
              <div class="port-stat-label">TEU/Year</div>
            </div>
            <div class="port-stat">
              <div class="port-stat-value ${
                port.efficiency >= 90
                  ? "good"
                  : port.efficiency >= 80
                  ? ""
                  : "warning"
              }">${port.efficiency}%</div>
              <div class="port-stat-label">Efficiency</div>
            </div>
            <div class="port-stat">
              <div class="port-stat-value">${port.vessels || "--"}</div>
              <div class="port-stat-label">Vessels</div>
            </div>
          </div>
        </div>
      `
          )
          .join("");
      }

      // Render chokepoints
      function renderChokepoints() {
        const grid = document.getElementById("chokepointsGrid");
        const chokepoints = supplyChainData.chokepoints || [];

        if (chokepoints.length === 0) {
          grid.innerHTML =
            '<p style="color: var(--text-secondary);">No chokepoint data available.</p>';
          return;
        }

        grid.innerHTML = chokepoints
          .map(
            (cp) => `
        <div class="choke-card" onclick="focusPort(${cp.lat}, ${cp.lon})">
          <div class="choke-header">
            <div class="choke-name">${cp.name}</div>
            <div class="choke-status ${cp.status}">${cp.status?.replace(
              "-",
              " "
            )}</div>
          </div>
          <div class="choke-info">
            <p><strong>Traffic:</strong> ${cp.traffic || "N/A"}</p>
            <p><strong>Trade Share:</strong> ${cp.tradeShare || "N/A"}</p>
          </div>
        </div>
      `
          )
          .join("");
      }

      // Focus map on location
      function focusPort(lat, lon) {
        map.flyTo([lat, lon], 5, { duration: 1 });
      }

      // Search functionality
      function setupSearch() {
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        
        searchInput.addEventListener('input', (e) => {
          const query = e.target.value.toLowerCase().trim();
          
          if (query.length < 2) {
            searchResults.classList.remove('active');
            return;
          }
          
          const results = [];
          
          // Search ports
          supplyChainData.hubs?.filter(h => h.type === 'port').forEach(port => {
            if (port.name.toLowerCase().includes(query) || port.country.toLowerCase().includes(query)) {
              results.push({
                type: 'port',
                title: port.name,
                meta: `${port.country} • ${port.throughput}M TEU`,
                lat: port.lat,
                lon: port.lon
              });
            }
          });
          
          // Search routes
          supplyChainData.routes?.forEach(route => {
            if (route.name.toLowerCase().includes(query)) {
              results.push({
                type: 'route',
                title: route.name,
                meta: `${route.distance?.toLocaleString()} km • ${route.transitDays} days`,
                route: route
              });
            }
          });
          
          // Search chokepoints
          supplyChainData.chokepoints?.forEach(cp => {
            if (cp.name.toLowerCase().includes(query)) {
              results.push({
                type: 'chokepoint',
                title: cp.name,
                meta: `${cp.status} • ${cp.traffic || 'N/A'}`,
                lat: cp.lat,
                lon: cp.lon
              });
            }
          });
          
          if (results.length > 0) {
            searchResults.innerHTML = results.slice(0, 8).map(r => `
              <div class="search-result-item" data-type="${r.type}" data-lat="${r.lat}" data-lon="${r.lon}" data-route="${r.route?.id || ''}">
                <div class="search-result-title">${r.type === 'port' ? '⚓' : r.type === 'route' ? '🚢' : '⚠️'} ${r.title}</div>
                <div class="search-result-meta">${r.meta}</div>
              </div>
            `).join('');
            searchResults.classList.add('active');
            
            // Add click handlers
            searchResults.querySelectorAll('.search-result-item').forEach(item => {
              item.addEventListener('click', () => {
                const type = item.dataset.type;
                if (type === 'route') {
                  const routeId = item.dataset.route;
                  const route = allRoutes.find(r => r.id === routeId);
                  if (route) {
                    map.fitBounds(route.polyline.getBounds(), { padding: [50, 50] });
                    route.polyline.openPopup();
                  }
                } else {
                  const lat = parseFloat(item.dataset.lat);
                  const lon = parseFloat(item.dataset.lon);
                  map.flyTo([lat, lon], 6, { duration: 1.5 });
                }
                searchResults.classList.remove('active');
                searchInput.value = '';
              });
            });
          } else {
            searchResults.innerHTML = '<div class="search-result-item" style="color: var(--text-secondary);">No results found</div>';
            searchResults.classList.add('active');
          }
        });
        
        // Close search results when clicking outside
        document.addEventListener('click', (e) => {
          if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.classList.remove('active');
          }
        });
      }
      
      // Setup event listeners
      function setupEventListeners() {
        setupSearch();
        // Map layer toggles
        document.querySelectorAll(".toggle-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            btn.classList.toggle("active");
            const layer = btn.dataset.layer;

            if (layer === "routes") {
              btn.classList.contains("active")
                ? map.addLayer(routesLayer)
                : map.removeLayer(routesLayer);
            } else if (layer === "ports") {
              btn.classList.contains("active")
                ? map.addLayer(portsLayer)
                : map.removeLayer(portsLayer);
            } else if (layer === "chokepoints") {
              btn.classList.contains("active")
                ? map.addLayer(chokepointsLayer)
                : map.removeLayer(chokepointsLayer);
            } else if (layer === "airports") {
              btn.classList.contains("active")
                ? map.addLayer(airportsLayer)
                : map.removeLayer(airportsLayer);
            }
          });
        });
        
        // Route filter buttons
        document.querySelectorAll('[data-route-filter]').forEach((btn) => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('[data-route-filter]').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            filterRoutes(btn.dataset.routeFilter);
          });
        });
        
        // Set default route filter to 'all' active
        document.querySelector('[data-route-filter="all"]')?.classList.add('active');

        // Region filters
        document.querySelectorAll(".filter-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            document
              .querySelectorAll(".filter-btn")
              .forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");
            renderPorts(btn.dataset.region);
          });
        });
      }

      // Live clock
      function updateClock() {
        const now = new Date();
        const hours = String(now.getUTCHours()).padStart(2, '0');
        const minutes = String(now.getUTCMinutes()).padStart(2, '0');
        const seconds = String(now.getUTCSeconds()).padStart(2, '0');
        document.getElementById('liveClock').textContent = `${hours}:${minutes}:${seconds}`;
      }
      
      // Update visible routes count
      function updateMapInfo() {
        const visibleCount = allRoutes.filter(r => routesLayer.hasLayer(r.polyline)).length;
        document.getElementById('visibleRoutes').textContent = visibleCount;
        document.getElementById('zoomLevel').textContent = map ? map.getZoom().toFixed(1) : '2';
      }
      
      // Export data as JSON
      function exportData() {
        const exportData = {
          timestamp: new Date().toISOString(),
          ports: supplyChainData.hubs?.filter(h => h.type === 'port').length || 0,
          routes: supplyChainData.routes?.length || 0,
          chokepoints: supplyChainData.chokepoints?.length || 0,
          data: supplyChainData
        };
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `supply-chain-data-${Date.now()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
      
      // Toggle fullscreen
      function toggleFullscreen() {
        const mapSection = document.querySelector('.map-section');
        if (!document.fullscreenElement) {
          mapSection.requestFullscreen().catch(err => {
            console.log('Fullscreen error:', err);
          });
        } else {
          document.exitFullscreen();
        }
      }
      
      // Add animated ships on major routes (optional visual enhancement)
      function addShipAnimations() {
        const majorRoutes = allRoutes.filter(r => 
          r.data.vessels > 30 && r.data.status === 'normal'
        ).slice(0, 3);
        
        majorRoutes.forEach(({polyline, data}) => {
          const latlngs = polyline.getLatLngs();
          if (latlngs.length < 2) return;
          
          const midPoint = latlngs[Math.floor(latlngs.length / 2)];
          const shipIcon = L.divIcon({
            className: 'ship-marker',
            html: '<svg width="12" height="12" viewBox="0 0 24 24" fill="#0ea5e9"><path d="M12 2L2 7l10 5 10-5-10-5z"/></svg>',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
          });
          
          L.marker([midPoint.lat, midPoint.lng], { icon: shipIcon })
            .bindTooltip(`${data.vessels} vessels active`, { permanent: false })
            .addTo(map);
        });
      }
      
      // Initialize on load
      document.addEventListener("DOMContentLoaded", () => {
        init();
        
        // Start live clock
        updateClock();
        setInterval(updateClock, 1000);
        
        // Setup action buttons
        document.getElementById('fullscreenBtn')?.addEventListener('click', toggleFullscreen);
        document.getElementById('exportBtn')?.addEventListener('click', exportData);
        
        // Update map info on zoom
        if (map) {
          map.on('zoomend', updateMapInfo);
          map.on('moveend', updateMapInfo);
        }
        
        // Add ship animations after map loads
        setTimeout(() => {
          if (map && allRoutes.length > 0) {
            addShipAnimations();
            updateMapInfo();
          }
        }, 1500);
      });
    </script>
  </body>
</html>

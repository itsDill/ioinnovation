<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trading Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        min-height: 100vh;
        padding: 20px;
        color: #333;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.98);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
      }

      h1 {
        text-align: center;
        color: #2c3e50;
        margin-bottom: 30px;
        font-size: 2.5rem;
        font-weight: 700;
      }

      .dashboard-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
      }

      .card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        border: 1px solid #e1e8ed;
        transition: transform 0.3s ease;
      }

      .card:hover {
        transform: translateY(-5px);
      }

      .card h2 {
        color: #2c3e50;
        margin-bottom: 20px;
        font-size: 1.5rem;
        border-bottom: 2px solid #3498db;
        padding-bottom: 10px;
        font-weight: 600;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #34495e;
      }

      input,
      select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: white;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
      }

      button {
        background: linear-gradient(45deg, #3498db, #2980b9);
        color: white;
        padding: 15px 30px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s ease;
        display: block;
        width: 100%;
        margin-top: 20px;
      }

      button:hover {
        background: linear-gradient(45deg, #2980b9, #3498db);
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      button:disabled {
        background: #95a5a6;
        cursor: not-allowed;
        transform: none;
      }

      .button-secondary {
        background: linear-gradient(45deg, #95a5a6, #7f8c8d);
        margin-top: 10px;
      }

      .button-secondary:hover {
        background: linear-gradient(45deg, #7f8c8d, #95a5a6);
      }

      .button-danger {
        background: linear-gradient(45deg, #e74c3c, #c0392b);
      }

      .button-danger:hover {
        background: linear-gradient(45deg, #c0392b, #e74c3c);
      }

      .button-success {
        background: linear-gradient(45deg, #27ae60, #229954);
      }

      .button-success:hover {
        background: linear-gradient(45deg, #229954, #27ae60);
      }

      .button-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 20px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        border-left: 4px solid #3498db;
        transition: transform 0.2s ease;
      }

      .stat-card:hover {
        transform: translateY(-2px);
      }

      .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 8px;
      }

      .stat-label {
        color: #7f8c8d;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 500;
      }

      .profit {
        color: #27ae60 !important;
      }
      .loss {
        color: #e74c3c !important;
      }

      .trade-history {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #e1e8ed;
        border-radius: 12px;
        background: white;
      }

      .trade-entry {
        padding: 15px;
        border-bottom: 1px solid #e1e8ed;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.2s ease;
      }

      .trade-entry:hover {
        background-color: #f8f9fa;
      }

      .trade-info {
        flex: 1;
      }

      .trade-result {
        font-weight: bold;
        padding: 8px 15px;
        border-radius: 20px;
        color: white;
        font-size: 0.9rem;
        min-width: 80px;
        text-align: center;
      }

      .progress-bar {
        width: 100%;
        height: 20px;
        background: #ecf0f1;
        border-radius: 10px;
        overflow: hidden;
        margin: 15px 0;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #27ae60, #2ecc71);
        transition: width 0.5s ease;
      }

      .alert {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-weight: 600;
      }

      .alert-success {
        background: #d5f5e3;
        color: #27ae60;
        border-left: 4px solid #27ae60;
      }

      .alert-danger {
        background: #fadbd8;
        color: #e74c3c;
        border-left: 4px solid #e74c3c;
      }

      .alert-warning {
        background: #fef5e7;
        color: #f39c12;
        border-left: 4px solid #f39c12;
      }

      .alert-info {
        background: #d6eaf8;
        color: #2e86c1;
        border-left: 4px solid #2e86c1;
      }

      .full-width {
        grid-column: 1 / -1;
      }

      .chart-container {
        height: 400px;
        background: white;
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #e1e8ed;
      }

      .pulse {
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      .header-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
      }

      .session-timer {
        background: rgba(52, 152, 219, 0.1);
        padding: 10px 20px;
        border-radius: 20px;
        color: #2c3e50;
        font-weight: 600;
        border: 2px solid #3498db;
      }

      .quick-actions {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-top: 20px;
      }

      .quick-action-btn {
        padding: 10px;
        font-size: 14px;
        margin-top: 0;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background-color: white;
        margin: 15% auto;
        padding: 30px;
        border-radius: 15px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }

      .close:hover {
        color: #000;
      }

      .streak-indicator {
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: bold;
        margin-left: 10px;
      }

      .win-streak {
        background: #d5f5e3;
        color: #27ae60;
      }

      .loss-streak {
        background: #fadbd8;
        color: #e74c3c;
      }

      @media (max-width: 768px) {
        .dashboard-grid {
          grid-template-columns: 1fr;
        }

        .container {
          padding: 20px;
        }

        h1 {
          font-size: 2rem;
        }

        .header-controls {
          flex-direction: column;
          gap: 15px;
        }

        .quick-actions {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header-controls">
        <h1>ðŸ“Š Trading Dashboard</h1>
        <div id="sessionTimer" class="session-timer" style="display: none">
          Session: 00:00:00
        </div>
      </div>

      <!-- Setup Section -->
      <div id="setupSection" class="card full-width">
        <h2>Account Setup</h2>
        <div style="display: grid; grid-template-columns: 1fr; gap: 20px">
          <div class="form-group">
            <label for="startingBalance">Account Balance ($)</label>
            <input
              type="number"
              id="startingBalance"
              value="100"
              step="0.01"
              min="1"
              placeholder="Enter your trading capital"
            />
          </div>
          <button onclick="startTrading()" class="pulse">
            Start Trading Session
          </button>
          <button onclick="loadDemo()" class="button-secondary">
            Load Demo Data
          </button>
        </div>
      </div>

      <!-- Stats Section -->
      <div id="statsSection" style="display: none">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="currentBalance">$100.00</div>
            <div class="stat-label">Current Balance</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="currentLotSize">0.01</div>
            <div class="stat-label">Current Lot Size</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="tradesInSet">0/5</div>
            <div class="stat-label">Trades in Set</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="dailyPnL">$0.00</div>
            <div class="stat-label">Daily P&L</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="winRate">0%</div>
            <div class="stat-label">Win Rate</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalTrades">0</div>
            <div class="stat-label">Total Trades</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="bestTrade">$0.00</div>
            <div class="stat-label">Best Trade</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="worstTrade">$0.00</div>
            <div class="stat-label">Worst Trade</div>
          </div>
        </div>
      </div>

      <!-- Trading Section -->
      <div id="tradingSection" style="display: none">
        <div class="dashboard-grid">
          <div class="card">
            <h2>Enter Trade</h2>
            <div class="form-group">
              <label for="instrument">Select Instrument</label>
              <select id="instrument">
                <option value="NASDAQ">NASDAQ</option>
                <option value="SP500">S&P 500</option>
                <option value="STOXX50">STOXX 50</option>
                <option value="DE30">DE30</option>
                <option value="JP225">JP225</option>
                <option value="EURUSD">EUR/USD</option>
                <option value="GBPUSD">GBP/USD</option>
                <option value="USDJPY">USD/JPY</option>
                <option value="GOLD">Gold</option>
                <option value="OIL">Oil</option>
              </select>
            </div>
            <div class="form-group">
              <label for="tradeResult">Trade Result ($)</label>
              <input
                type="number"
                id="tradeResult"
                step="0.01"
                placeholder="Enter profit (+) or loss (-)"
              />
            </div>
            <button onclick="submitTrade()" id="submitTradeBtn">
              Submit Trade
            </button>

            <div class="quick-actions">
              <button
                onclick="quickTrade('profit')"
                class="quick-action-btn button-success"
              >
                Quick Win
              </button>
              <button
                onclick="quickTrade('loss')"
                class="quick-action-btn button-danger"
              >
                Quick Loss
              </button>
              <button
                onclick="undoLastTrade()"
                class="quick-action-btn button-secondary"
              >
                Undo Last
              </button>
            </div>

            <div
              style="
                margin-top: 30px;
                background: #f8f9fa;
                padding: 15px;
                border-radius: 8px;
              "
            >
              <h3 style="margin-bottom: 15px; color: #2c3e50">
                Current Parameters
                <span
                  id="currentStreak"
                  class="streak-indicator"
                  style="display: none"
                ></span>
              </h3>
              <div
                style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px"
              >
                <div>
                  <div style="font-size: 0.9rem; color: #7f8c8d">Lot Size</div>
                  <div style="font-weight: bold" id="displayLotSize">0.01</div>
                </div>
                <div>
                  <div style="font-size: 0.9rem; color: #7f8c8d">
                    Profit Target
                  </div>
                  <div
                    style="font-weight: bold; color: #27ae60"
                    id="displayProfitTarget"
                  >
                    $0.30
                  </div>
                </div>
                <div>
                  <div style="font-size: 0.9rem; color: #7f8c8d">Max Loss</div>
                  <div
                    style="font-weight: bold; color: #e74c3c"
                    id="displayMaxLoss"
                  >
                    $0.15
                  </div>
                </div>
                <div>
                  <div style="font-size: 0.9rem; color: #7f8c8d">
                    Daily Max Loss
                  </div>
                  <div
                    style="font-weight: bold; color: #e74c3c"
                    id="displayDailyMaxLoss"
                  >
                    $1.50
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <h2>Set Progress & Controls</h2>
            <div class="progress-bar">
              <div
                class="progress-fill"
                id="setProgress"
                style="width: 0%"
              ></div>
            </div>
            <div style="text-align: center; margin: 15px 0; font-weight: 600">
              <span id="setProgressText">Trade 1 of 5</span>
            </div>

            <div class="button-row">
              <button onclick="showResetModal()" class="button-danger">
                Reset Session
              </button>
              <button onclick="exportData()" class="button-secondary">
                Export Data
              </button>
            </div>

            <div id="setCompleteSection" style="display: none">
              <div class="alert alert-warning">
                <strong>Set Complete!</strong> Enter your actual balance to
                proceed.
              </div>
              <div class="form-group">
                <label for="actualBalance">Actual Balance ($)</label>
                <input type="number" id="actualBalance" step="0.01" />
              </div>
              <button onclick="processSetCompletion()">Process Results</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Chart Section -->
      <div id="chartSection" style="display: none" class="card full-width">
        <h2>Balance Tracker</h2>
        <div class="chart-container">
          <canvas id="balanceChart"></canvas>
        </div>
      </div>

      <!-- History Section -->
      <div id="historySection" style="display: none" class="card full-width">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h2 style="margin-bottom: 0">Trade History</h2>
          <button
            onclick="clearHistory()"
            class="button-secondary"
            style="width: auto; margin: 0; padding: 8px 16px; font-size: 14px"
          >
            Clear History
          </button>
        </div>
        <div class="trade-history" id="tradeHistory">
          <div style="padding: 40px; text-align: center; color: #7f8c8d">
            No trades yet. Start trading to see your history here.
          </div>
        </div>
      </div>
    </div>

    <!-- Reset Confirmation Modal -->
    <div id="resetModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Reset Trading Session</h2>
          <span class="close" onclick="closeResetModal()">&times;</span>
        </div>
        <div class="alert alert-warning">
          <strong>Warning!</strong> This will permanently delete all your
          trading data, including:
        </div>
        <ul style="margin: 15px 0; padding-left: 20px">
          <li>All trade history</li>
          <li>Balance tracking</li>
          <li>Statistics and performance data</li>
          <li>Set completion records</li>
        </ul>
        <p style="margin-bottom: 20px; color: #7f8c8d">
          This action cannot be undone. Are you sure you want to continue?
        </p>
        <div class="button-row">
          <button onclick="closeResetModal()" class="button-secondary">
            Cancel
          </button>
          <button onclick="confirmReset()" class="button-danger">
            Reset Everything
          </button>
        </div>
      </div>
    </div>

    <script>
      // Trading state
      let tradingState = {
        startingBalance: 100,
        currentBalance: 100,
        currentLotSize: 0.01,
        takeProfitGoal: 0.3,
        maxLoss: 0.15,
        dailyMaxLoss: 1.5,
        tradesInCurrentSet: 0,
        currentSetStartBalance: 100,
        trades: [],
        sets: [],
        dailyPnL: 0,
        sessionActive: false,
        balanceHistory: [],
        currentLevel: 1,
        sessionStartTime: null,
        bestTrade: 0,
        worstTrade: 0,
        currentStreak: 0,
        streakType: null, // 'win' or 'loss'
      };

      // Chart.js instance
      let balanceChart = null;
      let sessionTimer = null;

      // Parameter levels based on account size
      const tradingParameters = [
        {
          minBalance: 0,
          maxBalance: 5,
          lotSize: 0.01,
          profitTarget: 0.3,
          maxLoss: 0.15,
          dailyMaxLoss: 1.5,
        },
        {
          minBalance: 5,
          maxBalance: 10,
          lotSize: 0.02,
          profitTarget: 0.6,
          maxLoss: 0.3,
          dailyMaxLoss: 3.0,
        },
        {
          minBalance: 10,
          maxBalance: 20,
          lotSize: 0.04,
          profitTarget: 1.2,
          maxLoss: 0.6,
          dailyMaxLoss: 6.0,
        },
        {
          minBalance: 20,
          maxBalance: 50,
          lotSize: 0.1,
          profitTarget: 3.0,
          maxLoss: 1.5,
          dailyMaxLoss: 15.0,
        },
        {
          minBalance: 50,
          maxBalance: 100,
          lotSize: 0.2,
          profitTarget: 6.0,
          maxLoss: 3.0,
          dailyMaxLoss: 30.0,
        },
        {
          minBalance: 100,
          maxBalance: 200,
          lotSize: 0.4,
          profitTarget: 12.0,
          maxLoss: 6.0,
          dailyMaxLoss: 60.0,
        },
        {
          minBalance: 200,
          maxBalance: 500,
          lotSize: 1.0,
          profitTarget: 30.0,
          maxLoss: 15.0,
          dailyMaxLoss: 150.0,
        },
        {
          minBalance: 500,
          maxBalance: Infinity,
          lotSize: 2.0,
          profitTarget: 60.0,
          maxLoss: 30.0,
          dailyMaxLoss: 300.0,
        },
      ];

      function getParametersForBalance(balance) {
        return (
          tradingParameters.find(
            (level) => balance > level.minBalance && balance <= level.maxBalance
          ) || tradingParameters[0]
        );
      }

      function updateTradingParameters() {
        const params = getParametersForBalance(tradingState.currentBalance);
        tradingState.currentLotSize = params.lotSize;
        tradingState.takeProfitGoal = params.profitTarget;
        tradingState.maxLoss = params.maxLoss;
        tradingState.dailyMaxLoss = params.dailyMaxLoss;

        // Update display
        document.getElementById("displayLotSize").textContent =
          params.lotSize.toFixed(2);
        document.getElementById(
          "displayProfitTarget"
        ).textContent = `$${params.profitTarget.toFixed(2)}`;
        document.getElementById(
          "displayMaxLoss"
        ).textContent = `$${params.maxLoss.toFixed(2)}`;
        document.getElementById(
          "displayDailyMaxLoss"
        ).textContent = `$${params.dailyMaxLoss.toFixed(2)}`;
      }

      function updateSessionTimer() {
        if (!tradingState.sessionStartTime) return;

        const now = new Date();
        const elapsed = now - tradingState.sessionStartTime;
        const hours = Math.floor(elapsed / 3600000);
        const minutes = Math.floor((elapsed % 3600000) / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);

        const timeString = `${hours.toString().padStart(2, "0")}:${minutes
          .toString()
          .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
        document.getElementById(
          "sessionTimer"
        ).textContent = `Session: ${timeString}`;
      }

      function updateStreakIndicator() {
        const streakElement = document.getElementById("currentStreak");

        if (tradingState.currentStreak >= 2) {
          streakElement.style.display = "inline-block";
          streakElement.textContent = `${tradingState.currentStreak} ${tradingState.streakType} streak`;
          streakElement.className = `streak-indicator ${
            tradingState.streakType === "win" ? "win-streak" : "loss-streak"
          }`;
        } else {
          streakElement.style.display = "none";
        }
      }

      function initializeChart() {
        const ctx = document.getElementById("balanceChart").getContext("2d");

        tradingState.balanceHistory = [
          {
            trade: 0,
            balance: tradingState.startingBalance,
            timestamp: new Date(),
          },
        ];

        balanceChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: ["Start"],
            datasets: [
              {
                label: "Account Balance ($)",
                data: [tradingState.startingBalance],
                borderColor: "#3498db",
                backgroundColor: "rgba(52, 152, 219, 0.1)",
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: "#3498db",
                pointBorderColor: "#ffffff",
                pointBorderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 8,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: "top",
              },
            },
            scales: {
              x: {
                title: {
                  display: true,
                  text: "Trade Number",
                },
              },
              y: {
                title: {
                  display: true,
                  text: "Balance ($)",
                },
                ticks: {
                  callback: function (value) {
                    return "$" + value.toFixed(2);
                  },
                },
              },
            },
          },
        });
      }

      function updateChart() {
        if (!balanceChart) return;

        const labels = tradingState.balanceHistory.map((_, index) =>
          index === 0 ? "Start" : `Trade ${index}`
        );
        const data = tradingState.balanceHistory.map((entry) => entry.balance);

        balanceChart.data.labels = labels;
        balanceChart.data.datasets[0].data = data;

        // Color the line based on performance
        const currentBalance = tradingState.currentBalance;
        const startingBalance = tradingState.startingBalance;

        if (currentBalance > startingBalance) {
          balanceChart.data.datasets[0].borderColor = "#27ae60";
          balanceChart.data.datasets[0].backgroundColor =
            "rgba(39, 174, 96, 0.1)";
        } else if (currentBalance < startingBalance) {
          balanceChart.data.datasets[0].borderColor = "#e74c3c";
          balanceChart.data.datasets[0].backgroundColor =
            "rgba(231, 76, 60, 0.1)";
        } else {
          balanceChart.data.datasets[0].borderColor = "#3498db";
          balanceChart.data.datasets[0].backgroundColor =
            "rgba(52, 152, 219, 0.1)";
        }

        balanceChart.update();
      }

      function startTrading() {
        const startingBalance = parseFloat(
          document.getElementById("startingBalance").value
        );

        if (isNaN(startingBalance) || startingBalance <= 0) {
          alert("Please enter a valid starting balance");
          return;
        }

        // Initialize trading state
        tradingState.startingBalance = startingBalance;
        tradingState.currentBalance = startingBalance;
        tradingState.currentSetStartBalance = startingBalance;
        tradingState.sessionActive = true;
        tradingState.sessionStartTime = new Date();
        tradingState.balanceHistory = [
          {
            trade: 0,
            balance: startingBalance,
            timestamp: new Date(),
          },
        ];

        updateTradingParameters();
        updateDisplay();
        initializeChart();

        // Show trading sections
        document.getElementById("setupSection").style.display = "none";
        document.getElementById("statsSection").style.display = "block";
        document.getElementById("tradingSection").style.display = "block";
        document.getElementById("chartSection").style.display = "block";
        document.getElementById("historySection").style.display = "block";
        document.getElementById("sessionTimer").style.display = "block";

        // Start session timer
        sessionTimer = setInterval(updateSessionTimer, 1000);

        showAlert("Trading session started successfully!", "success");
      }

      function loadDemo() {
        // Load demo data with some sample trades
        tradingState = {
          startingBalance: 100,
          currentBalance: 105.5,
          currentLotSize: 0.01,
          takeProfitGoal: 0.3,
          maxLoss: 0.15,
          dailyMaxLoss: 1.5,
          tradesInCurrentSet: 2,
          currentSetStartBalance: 100,
          trades: [
            {
              id: 1,
              instrument: "NASDAQ",
              result: 2.5,
              timestamp: new Date(Date.now() - 3600000),
              balance: 102.5,
              lotSize: 0.01,
            },
            {
              id: 2,
              instrument: "EURUSD",
              result: -1.0,
              timestamp: new Date(Date.now() - 1800000),
              balance: 101.5,
              lotSize: 0.01,
            },
            {
              id: 3,
              instrument: "GOLD",
              result: 4.0,
              timestamp: new Date(Date.now() - 900000),
              balance: 105.5,
              lotSize: 0.01,
            },
          ],
          sets: [],
          dailyPnL: 5.5,
          sessionActive: true,
          balanceHistory: [
            {
              trade: 0,
              balance: 100,
              timestamp: new Date(Date.now() - 4000000),
            },
            {
              trade: 1,
              balance: 102.5,
              timestamp: new Date(Date.now() - 3600000),
            },
            {
              trade: 2,
              balance: 101.5,
              timestamp: new Date(Date.now() - 1800000),
            },
            {
              trade: 3,
              balance: 105.5,
              timestamp: new Date(Date.now() - 900000),
            },
          ],
          currentLevel: 1,
          sessionStartTime: new Date(Date.now() - 4000000),
          bestTrade: 4.0,
          worstTrade: -1.0,
          currentStreak: 1,
          streakType: "win",
        };

        updateTradingParameters();
        updateDisplay();
        initializeChart();
        updateTradeHistory();

        // Show trading sections
        document.getElementById("setupSection").style.display = "none";
        document.getElementById("statsSection").style.display = "block";
        document.getElementById("tradingSection").style.display = "block";
        document.getElementById("chartSection").style.display = "block";
        document.getElementById("historySection").style.display = "block";
        document.getElementById("sessionTimer").style.display = "block";

        // Start session timer
        sessionTimer = setInterval(updateSessionTimer, 1000);

        showAlert("Demo data loaded successfully!", "info");
      }

      function submitTrade() {
        const instrument = document.getElementById("instrument").value;
        const result = parseFloat(document.getElementById("tradeResult").value);

        if (isNaN(result) || result === 0) {
          showAlert("Please enter a valid trade result", "danger");
          return;
        }

        // Check if trade exceeds max loss
        if (result < 0 && Math.abs(result) > tradingState.maxLoss) {
          if (
            !confirm(
              `This loss ($${Math.abs(result).toFixed(
                2
              )}) exceeds your max loss limit ($${tradingState.maxLoss.toFixed(
                2
              )}). Are you sure?`
            )
          ) {
            return;
          }
        }

        // Check daily max loss
        const potentialDailyPnL = tradingState.dailyPnL + result;
        if (potentialDailyPnL < -tradingState.dailyMaxLoss) {
          showAlert(
            `This trade would exceed your daily max loss limit ($${tradingState.dailyMaxLoss.toFixed(
              2
            )})`,
            "danger"
          );
          return;
        }

        processTrade(instrument, result);
      }

      function quickTrade(type) {
        const instrument = document.getElementById("instrument").value;
        let result;

        if (type === "profit") {
          result = tradingState.takeProfitGoal;
        } else {
          result = -tradingState.maxLoss;
        }

        processTrade(instrument, result);
      }

      function processTrade(instrument, result) {
        // Update balance and daily P&L
        tradingState.currentBalance += result;
        tradingState.dailyPnL += result;
        tradingState.tradesInCurrentSet++;

        // Update best/worst trades
        if (result > tradingState.bestTrade) {
          tradingState.bestTrade = result;
        }
        if (result < tradingState.worstTrade) {
          tradingState.worstTrade = result;
        }

        // Update streak
        if (result > 0) {
          if (tradingState.streakType === "win") {
            tradingState.currentStreak++;
          } else {
            tradingState.currentStreak = 1;
            tradingState.streakType = "win";
          }
        } else {
          if (tradingState.streakType === "loss") {
            tradingState.currentStreak++;
          } else {
            tradingState.currentStreak = 1;
            tradingState.streakType = "loss";
          }
        }

        // Create trade record
        const trade = {
          id: tradingState.trades.length + 1,
          instrument: instrument,
          result: result,
          timestamp: new Date(),
          balance: tradingState.currentBalance,
          lotSize: tradingState.currentLotSize,
        };

        tradingState.trades.push(trade);

        // Add to balance history
        tradingState.balanceHistory.push({
          trade: tradingState.trades.length,
          balance: tradingState.currentBalance,
          timestamp: new Date(),
        });

        // Clear input
        document.getElementById("tradeResult").value = "";

        // Update displays
        updateTradingParameters();
        updateDisplay();
        updateChart();
        updateTradeHistory();
        updateStreakIndicator();

        // Check if set is complete
        if (tradingState.tradesInCurrentSet >= 5) {
          showSetComplete();
        }

        // Show success message
        const resultText =
          result > 0
            ? `+$${result.toFixed(2)}`
            : `-$${Math.abs(result).toFixed(2)}`;
        showAlert(
          `Trade recorded: ${resultText} on ${instrument}`,
          result > 0 ? "success" : "danger"
        );
      }

      function undoLastTrade() {
        if (tradingState.trades.length === 0) {
          showAlert("No trades to undo", "warning");
          return;
        }

        if (!confirm("Are you sure you want to undo the last trade?")) {
          return;
        }

        const lastTrade = tradingState.trades.pop();

        // Revert balance and daily P&L
        tradingState.currentBalance -= lastTrade.result;
        tradingState.dailyPnL -= lastTrade.result;
        tradingState.tradesInCurrentSet--;

        // Remove from balance history
        tradingState.balanceHistory.pop();

        // Recalculate best/worst trades
        tradingState.bestTrade = 0;
        tradingState.worstTrade = 0;
        tradingState.trades.forEach((trade) => {
          if (trade.result > tradingState.bestTrade) {
            tradingState.bestTrade = trade.result;
          }
          if (trade.result < tradingState.worstTrade) {
            tradingState.worstTrade = trade.result;
          }
        });

        // Recalculate streak
        tradingState.currentStreak = 0;
        tradingState.streakType = null;
        if (tradingState.trades.length > 0) {
          let streak = 1;
          const lastResult =
            tradingState.trades[tradingState.trades.length - 1].result;
          const type = lastResult > 0 ? "win" : "loss";

          for (let i = tradingState.trades.length - 2; i >= 0; i--) {
            const currentType =
              tradingState.trades[i].result > 0 ? "win" : "loss";
            if (currentType === type) {
              streak++;
            } else {
              break;
            }
          }

          tradingState.currentStreak = streak;
          tradingState.streakType = type;
        }

        updateTradingParameters();
        updateDisplay();
        updateChart();
        updateTradeHistory();
        updateStreakIndicator();

        showAlert("Last trade undone successfully", "info");
      }

      function showSetComplete() {
        document.getElementById("setCompleteSection").style.display = "block";
        document.getElementById("submitTradeBtn").disabled = true;
        showAlert(
          "Set of 5 trades completed! Enter your actual balance to continue.",
          "warning"
        );
      }

      function processSetCompletion() {
        const actualBalance = parseFloat(
          document.getElementById("actualBalance").value
        );

        if (isNaN(actualBalance) || actualBalance <= 0) {
          showAlert("Please enter a valid actual balance", "danger");
          return;
        }

        // Calculate set results
        const theoreticalResult =
          tradingState.currentBalance - tradingState.currentSetStartBalance;
        const actualResult =
          actualBalance - tradingState.currentSetStartBalance;
        const variance = actualResult - theoreticalResult;

        // Record set completion
        const setRecord = {
          setNumber: tradingState.sets.length + 1,
          startingBalance: tradingState.currentSetStartBalance,
          theoreticalBalance: tradingState.currentBalance,
          actualBalance: actualBalance,
          theoreticalResult: theoreticalResult,
          actualResult: actualResult,
          variance: variance,
          trades: tradingState.trades.slice(-5),
          timestamp: new Date(),
        };

        tradingState.sets.push(setRecord);

        // Update current balance to actual balance
        tradingState.currentBalance = actualBalance;
        tradingState.currentSetStartBalance = actualBalance;
        tradingState.tradesInCurrentSet = 0;

        // Add actual balance to history
        tradingState.balanceHistory.push({
          trade: tradingState.trades.length + 0.5,
          balance: actualBalance,
          timestamp: new Date(),
          isActual: true,
        });

        // Reset set complete section
        document.getElementById("setCompleteSection").style.display = "none";
        document.getElementById("submitTradeBtn").disabled = false;
        document.getElementById("actualBalance").value = "";

        // Update all displays
        updateTradingParameters();
        updateDisplay();
        updateChart();

        // Show completion message
        const varianceText =
          variance >= 0
            ? `+$${variance.toFixed(2)}`
            : `-$${Math.abs(variance).toFixed(2)}`;
        showAlert(
          `Set completed! Variance from theoretical: ${varianceText}`,
          variance >= 0 ? "success" : "warning"
        );
      }

      function updateDisplay() {
        // Update stats
        document.getElementById(
          "currentBalance"
        ).textContent = `$${tradingState.currentBalance.toFixed(2)}`;
        document.getElementById("currentLotSize").textContent =
          tradingState.currentLotSize.toFixed(2);
        document.getElementById(
          "tradesInSet"
        ).textContent = `${tradingState.tradesInCurrentSet}/5`;

        const dailyPnLElement = document.getElementById("dailyPnL");
        dailyPnLElement.textContent = `$${tradingState.dailyPnL.toFixed(2)}`;
        dailyPnLElement.className = `stat-value ${
          tradingState.dailyPnL >= 0 ? "profit" : "loss"
        }`;

        // Calculate win rate
        const winningTrades = tradingState.trades.filter(
          (trade) => trade.result > 0
        ).length;
        const winRate =
          tradingState.trades.length > 0
            ? (winningTrades / tradingState.trades.length) * 100
            : 0;
        document.getElementById("winRate").textContent = `${winRate.toFixed(
          1
        )}%`;

        document.getElementById("totalTrades").textContent =
          tradingState.trades.length;

        const bestTradeElement = document.getElementById("bestTrade");
        bestTradeElement.textContent = `$${tradingState.bestTrade.toFixed(2)}`;
        bestTradeElement.className = `stat-value ${
          tradingState.bestTrade >= 0 ? "profit" : ""
        }`;

        const worstTradeElement = document.getElementById("worstTrade");
        worstTradeElement.textContent = `$${tradingState.worstTrade.toFixed(
          2
        )}`;
        worstTradeElement.className = `stat-value ${
          tradingState.worstTrade < 0 ? "loss" : ""
        }`;

        // Update set progress
        const progressPercent = (tradingState.tradesInCurrentSet / 5) * 100;
        document.getElementById(
          "setProgress"
        ).style.width = `${progressPercent}%`;
        document.getElementById("setProgressText").textContent = `Trade ${
          tradingState.tradesInCurrentSet + 1
        } of 5`;
      }

      function updateTradeHistory() {
        const historyContainer = document.getElementById("tradeHistory");

        if (tradingState.trades.length === 0) {
          historyContainer.innerHTML =
            '<div style="padding: 40px; text-align: center; color: #7f8c8d;">No trades yet. Start trading to see your history here.</div>';
          return;
        }

        const historyHTML = tradingState.trades
          .slice()
          .reverse()
          .map((trade) => {
            const resultClass = trade.result > 0 ? "profit" : "loss";
            const resultText =
              trade.result > 0
                ? `+$${trade.result.toFixed(2)}`
                : `-$${Math.abs(trade.result).toFixed(2)}`;
            const timeText = trade.timestamp.toLocaleTimeString();

            return `
              <div class="trade-entry">
                <div class="trade-info">
                  <div style="font-weight: 600; margin-bottom: 5px;">
                    ${trade.instrument} - ${timeText}
                  </div>
                  <div style="font-size: 0.9rem; color: #7f8c8d;">
                    Balance: $${trade.balance.toFixed(
                      2
                    )} | Lot: ${trade.lotSize.toFixed(2)}
                  </div>
                </div>
                <div class="trade-result" style="background: ${
                  trade.result > 0 ? "#27ae60" : "#e74c3c"
                };">
                  ${resultText}
                </div>
              </div>
            `;
          })
          .join("");

        historyContainer.innerHTML = historyHTML;
      }

      function clearHistory() {
        if (tradingState.trades.length === 0) {
          showAlert("No history to clear", "info");
          return;
        }

        if (
          !confirm(
            "Are you sure you want to clear all trade history? This action cannot be undone."
          )
        ) {
          return;
        }

        // Reset only the trades and history, keep session active
        tradingState.trades = [];
        tradingState.balanceHistory = [
          {
            trade: 0,
            balance: tradingState.currentBalance,
            timestamp: new Date(),
          },
        ];
        tradingState.dailyPnL = 0;
        tradingState.bestTrade = 0;
        tradingState.worstTrade = 0;
        tradingState.currentStreak = 0;
        tradingState.streakType = null;
        tradingState.tradesInCurrentSet = 0;
        tradingState.currentSetStartBalance = tradingState.currentBalance;

        updateDisplay();
        updateChart();
        updateTradeHistory();
        updateStreakIndicator();

        showAlert("Trade history cleared successfully", "info");
      }

      function showResetModal() {
        document.getElementById("resetModal").style.display = "block";
      }

      function closeResetModal() {
        document.getElementById("resetModal").style.display = "none";
      }

      function confirmReset() {
        // Stop session timer
        if (sessionTimer) {
          clearInterval(sessionTimer);
          sessionTimer = null;
        }

        // Reset all state
        tradingState = {
          startingBalance: 100,
          currentBalance: 100,
          currentLotSize: 0.01,
          takeProfitGoal: 0.3,
          maxLoss: 0.15,
          dailyMaxLoss: 1.5,
          tradesInCurrentSet: 0,
          currentSetStartBalance: 100,
          trades: [],
          sets: [],
          dailyPnL: 0,
          sessionActive: false,
          balanceHistory: [],
          currentLevel: 1,
          sessionStartTime: null,
          bestTrade: 0,
          worstTrade: 0,
          currentStreak: 0,
          streakType: null,
        };

        // Reset UI
        document.getElementById("setupSection").style.display = "block";
        document.getElementById("statsSection").style.display = "none";
        document.getElementById("tradingSection").style.display = "none";
        document.getElementById("chartSection").style.display = "none";
        document.getElementById("historySection").style.display = "none";
        document.getElementById("sessionTimer").style.display = "none";
        document.getElementById("setCompleteSection").style.display = "none";
        document.getElementById("submitTradeBtn").disabled = false;

        // Reset form
        document.getElementById("startingBalance").value = "100";
        document.getElementById("tradeResult").value = "";
        document.getElementById("actualBalance").value = "";

        closeResetModal();
        showAlert("Trading session reset successfully", "info");
      }

      function exportData() {
        const exportData = {
          session: {
            startTime: tradingState.sessionStartTime,
            startingBalance: tradingState.startingBalance,
            currentBalance: tradingState.currentBalance,
            dailyPnL: tradingState.dailyPnL,
            totalTrades: tradingState.trades.length,
          },
          trades: tradingState.trades,
          sets: tradingState.sets,
          balanceHistory: tradingState.balanceHistory,
          statistics: {
            winRate:
              tradingState.trades.length > 0
                ? (tradingState.trades.filter((t) => t.result > 0).length /
                    tradingState.trades.length) *
                  100
                : 0,
            bestTrade: tradingState.bestTrade,
            worstTrade: tradingState.worstTrade,
            currentStreak: tradingState.currentStreak,
            streakType: tradingState.streakType,
          },
        };

        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(dataBlob);

        const link = document.createElement("a");
        link.href = url;
        link.download = `trading-session-${
          new Date().toISOString().split("T")[0]
        }.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        showAlert("Trading data exported successfully", "success");
      }

      function showAlert(message, type) {
        // Remove existing alerts
        const existingAlerts = document.querySelectorAll(".alert");
        existingAlerts.forEach((alert) => alert.remove());

        // Create new alert
        const alert = document.createElement("div");
        alert.className = `alert alert-${type}`;
        alert.innerHTML = `<strong>${
          type === "success"
            ? "Success!"
            : type === "danger"
            ? "Error!"
            : type === "warning"
            ? "Warning!"
            : "Info!"
        }</strong> ${message}`;

        // Insert at the top of the container
        const container = document.querySelector(".container");
        container.insertBefore(alert, container.firstChild);

        // Auto-remove after 5 seconds
        setTimeout(() => {
          if (alert && alert.parentNode) {
            alert.remove();
          }
        }, 5000);
      }

      // Close modal when clicking outside
      window.onclick = function (event) {
        const modal = document.getElementById("resetModal");
        if (event.target == modal) {
          closeResetModal();
        }
      };

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", function () {
        // Set focus on starting balance input
        document.getElementById("startingBalance").focus();

        // Add enter key support for trade submission
        document
          .getElementById("tradeResult")
          .addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              submitTrade();
            }
          });

        // Add enter key support for set completion
        document
          .getElementById("actualBalance")
          .addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              processSetCompletion();
            }
          });
      });
    </script>
  </body>
</html>
